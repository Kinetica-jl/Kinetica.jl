<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementation Details · Kinetica.jl</title><meta name="title" content="Implementation Details · Kinetica.jl"/><meta property="og:title" content="Implementation Details · Kinetica.jl"/><meta property="twitter:title" content="Implementation Details · Kinetica.jl"/><meta name="description" content="Documentation for the Kinetica.jl package and its modular kinetic calculators."/><meta property="og:description" content="Documentation for the Kinetica.jl package and its modular kinetic calculators."/><meta property="twitter:description" content="Documentation for the Kinetica.jl package and its modular kinetic calculators."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="Kinetica.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Kinetica.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../getting-started/">Getting Started</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/arbitrary-conditions/">Arbitrary Simulation Conditions</a></li><li><a class="tocitem" href="../../tutorials/ode-solution/">ODE Solution</a></li><li><a class="tocitem" href="../../tutorials/kinetic-calculators/">Kinetic Calculators</a></li><li><a class="tocitem" href="../../tutorials/iterative-exploration/">Iterative CRN Exploration</a></li><li><a class="tocitem" href="../../tutorials/results-analysis/">Results Analysis</a></li><li><a class="tocitem" href="../../tutorials/filtering-crns/">Filtering CRNs</a></li><li><a class="tocitem" href="../../tutorials/saving-loading/">Saving &amp; Loading</a></li><li><a class="tocitem" href="../../tutorials/logging/">Logging</a></li></ul></li><li><span class="tocitem">Developing with Kinetica</span><ul><li><a class="tocitem" href="../crn-representation/">CRN Representation</a></li><li><a class="tocitem" href="../condition-profiles/">Condition Profiles</a></li><li><a class="tocitem" href="../calculator-interface/">Calculator Interface</a></li><li><a class="tocitem" href="../ase-calculator-builders/">ASE Calculator Builders</a></li><li class="is-active"><a class="tocitem" href>Implementation Details</a><ul class="internal"><li><a class="tocitem" href="#implementation_chunkwise_time"><span>Chunkwise Time</span></a></li><li><a class="tocitem" href="#implementation_adaptive_tolerance"><span>Adaptive Solver Tolerance</span></a></li><li><a class="tocitem" href="#implementation_low_rate"><span>Removing Low-Rate Reactions</span></a></li></ul></li></ul></li><li><span class="tocitem">API</span><ul><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">Kinetica.jl</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/kinetica/exploration/">Exploration</a></li><li><a class="tocitem" href="../../api/kinetica/solving/">Solving</a></li><li><a class="tocitem" href="../../api/kinetica/conditions/">Conditions</a></li><li><a class="tocitem" href="../../api/kinetica/analysis/">Analysis</a></li><li><a class="tocitem" href="../../api/kinetica/openbabel/">Open Babel</a></li><li><a class="tocitem" href="../../api/kinetica/rdkit/">RDKit</a></li><li><a class="tocitem" href="../../api/kinetica/utilities/">Utilities</a></li><li><input class="collapse-toggle" id="menuitem-5-1-8" type="checkbox"/><label class="tocitem" for="menuitem-5-1-8"><span class="docs-label">ASE Interface</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/kinetica/ase_calculator/calculator/">Kinetic Calculator</a></li><li><a class="tocitem" href="../../api/kinetica/ase_calculator/optimisation/">Optimisation</a></li><li><a class="tocitem" href="../../api/kinetica/ase_calculator/builders/">Builders</a></li><li><a class="tocitem" href="../../api/kinetica/ase_calculator/utilities/">Utilities</a></li></ul></li><li><a class="tocitem" href="../../api/kinetica/autode/">autodE Interface</a></li></ul></li><li><a class="tocitem" href="../../api/kineticakpm/">KineticaKPM.jl</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developing with Kinetica</a></li><li class="is-active"><a href>Implementation Details</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementation Details</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Kinetica-jl/Kinetica.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementation-Details"><a class="docs-heading-anchor" href="#Implementation-Details">Implementation Details</a><a id="Implementation-Details-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-Details" title="Permalink"></a></h1><p>The purpose of this page is to expand on the definition and implementation of some of the features in Kinetica that appear in other pages within this documentation. Sections here are not critical to the understanding of how to use parts of Kinetica, but may be necessary for development purpooses.</p><h2 id="implementation_chunkwise_time"><a class="docs-heading-anchor" href="#implementation_chunkwise_time">Chunkwise Time</a><a id="implementation_chunkwise_time-1"></a><a class="docs-heading-anchor-permalink" href="#implementation_chunkwise_time" title="Permalink"></a></h2><p>Chunkwise simulation time is mentioned primarily in the tutorial on <a href="../../tutorials/ode-solution/#ODE-Solution">ODE Solution</a>. It is a workaround to a floating point underflow issue that is caused by accumulating extremely small timesteps onto a relatively large global simulation time (GST), <span>$t_{\text{global}}$</span>. </p><p>To be more precise, assuming <span>$t_{\text{global}}$</span> is represented by an IEEE 64-bit floating point number (i.e. a <code>Float64</code>) where the smallest precision that is computationally representable <span>$\epsilon = 2^{-53} \simeq 10^{-16}$</span>. The smallest value that can be added at any given time is therefore <span>$t_{\text{global}} \epsilon$</span>. When very small timesteps are being taken and the GST is large, underflow occurs.</p><p>In practice, the impact of this problem can be seemingly minimal, with most simulations running without issue. However, closer inspection of the timesteps being taken reveals that floating point underflow can still occur in otherwise convergent simulations. We theorise that this is actually due to x86-64 processors allowing for a limited set of computations to take place on <a href="https://en.wikipedia.org/wiki/Extended_precision#x86_extended_precision_format">extended precision</a> 80-bit floating point numbers where <span>$\epsilon=2^{63}\approx10^{-18}$</span> when necessary, which only appear to underflow when being converted back to <code>Float64</code> in memory. However, this is slower than performing the respective 64-bit operations and is entirely implementation and platform-dependent, should not be relied upon to always work.</p><p>Enabling chunkwise time (<code>ODESimulationParams.solve_chunks=true</code>) therefore splits the overall simulation timespan (<code>ODESimulationParams.tspan</code>) into &#39;chunks&#39; of local time, each of length <code>ODESimulationParams.solve_chunkstep</code>, or <span>$\tau_c$</span>.</p><div class="admonition is-warning" id="Uneven-Chunk-Splits-5e8fb86a352cc9cd"><header class="admonition-header">Uneven Chunk Splits<a class="admonition-anchor" href="#Uneven-Chunk-Splits-5e8fb86a352cc9cd" title="Permalink"></a></header><div class="admonition-body"><p>Currently, Kinetica only supports splitting simulations into chunks with the same <span>$\tau_c$</span>. This means that <code>ODESimulationParams.tspan[2] - ODESimulationParams.tspan[1]</code> must be evenly divisible by <code>ODESimulationParams.solve_chunkstep</code>, such that an integer number of chunks are created.</p></div></div><p>The first simulation chunk is initialised with species concentrations <span>$\mathbf{c}=\mathbf{c_0}$</span>, <span>$t_{\text{global}}=0.0$</span>, local simulation time (LST) <span>$t_{\text{local}}=0.0$</span> and number of chunks <span>$n_c = 0$</span>. Integration of species concentrations then proceeds with respect to <span>$t_{\text{local}}$</span> until <span>$t_{\text{local}}=\tau_c$</span>, at which point the concentrations and their respective LSTs are saved to a global-time array. In this array, <span>$t_{\text{global}}$</span> is calculated as</p><p class="math-container">\[t_{\text{global}} = t_{\text{local}} + \tau_c n_c\]</p><p>and species concentrations and times are interpolated onto a grid of save times</p><p class="math-container">\[\mathbf{t_{\text{saves}}}=\left( \tau_{\text{save}}n \right)_{n=0}^{\tau_{c}/\tau_{\text{save}}}\]</p><p>where <span>$\tau_{\text{save}}$</span> is simply <code>ODESimulationParams.save_interval</code>.</p><p>The solver is then reinitialised at <span>$t_{\text{local}}=0.0$</span> with <span>$\mathbf{c}=\mathbf{c_{\text{final}}}$</span>, where <span>$\mathbf{c_{\text{final}}}$</span> is the species concentrations at the end of the previous chunk, and <span>$n_c$</span> is incremented. This continues until <span>$t_{\text{global}}$</span> reaches <code>ODESimulationParams.tspan[2]</code>. By replacing <span>$t_{\text{global}}$</span> with a <span>$t_{\text{local}}$</span> that can never become very large during timestep accumulation, timesteps can be safely taken down to values of <span>$\tau_c \epsilon$</span>. This allows long-timescale, high-rate simulations to proceed unhindered by floating point underflow.</p><h2 id="implementation_adaptive_tolerance"><a class="docs-heading-anchor" href="#implementation_adaptive_tolerance">Adaptive Solver Tolerance</a><a id="implementation_adaptive_tolerance-1"></a><a class="docs-heading-anchor-permalink" href="#implementation_adaptive_tolerance" title="Permalink"></a></h2><p>When solving <code>ODESystem</code>s, adaptive timestepping ODE solvers requires two tolerances (<code>abstol</code> and <code>reltol</code>, given within Kinetica through <code>ODESimulationParams.abstol</code> and <code>ODESimulationParams.reltol</code> respectively) which control the numeric error allowed within the solver. A balance must be struck with these tolerances, as setting very low values increases solution accuracy, at the cost of taking many more small timesteps in order to achieve this.</p><p>By default, these tolerances are set at the start of a simulation and remain constant throughout. This can be a problem if the solver runs into an area of the simulation where an accurate solution cannot be obtained at the current tolerances, as the solver will throw an error and crash. To avoid this, Kinetica implements an adaptive-tolerance solution method based around DifferentialEquations.jl&#39;s <a href="https://docs.sciml.ai/DiffEqDocs/stable/basics/integrator/">integrator interface</a>. This method is enabled with the <code>ODESimulationParams.adaptive_tols</code> parameter.</p><p>This method takes a pre-assembled integrator, and attempts to solve the underlying <code>ODEProblem</code> at the initially requested tolerances. If this is not possible, <code>abstol</code> and <code>reltol</code> are decreased by a factor of 10, reducing numerical error at the cost of a more expensive simulation. The tolerances are decreased until one or both fall below the precision of the numeric type used within the simulation, at which point an error will be returned as the simulation cannot be solved. An error is also returned if more than five tolerance changes have been attempted, to avoid needlessly running expensive, impossible simulations.</p><p>If the solver tolerances need to be modified during adaptive tolerance solution and <code>ODESimulationParams.update_tols=true</code>, the changes to the tolerances will be echoed back to the <a href="../../api/kinetica/solving/#Kinetica.ODESimulationParams"><code>ODESimulationParams</code></a> object returned within the simulation&#39;s <a href="../../api/kinetica/analysis/#Kinetica.ODESolveOutput"><code>ODESolveOutput</code></a>, which can be useful if similar simulations need to be rerun with the same parameters, as the solver tolerances will stay at workable values.</p><div class="admonition is-info" id="Adaptive-tolerance-in-chunkwise-simulations-f8847eecbd294e42"><header class="admonition-header">Adaptive tolerance in chunkwise simulations<a class="admonition-anchor" href="#Adaptive-tolerance-in-chunkwise-simulations-f8847eecbd294e42" title="Permalink"></a></header><div class="admonition-body"><p>The behaviour enabled with <code>ODESimulationParams.update_tols=true</code> is usually not desired when running simulations with chunkwise time. Decreased solver tolerances are often only required in localised areas of time within kinetic simulations where reactions are proceeding exceptionally quickly and there are very large changes in species concentrations. As such, decreased tolerances may only be necessary within a few simulation chunks, while the rest of the simulation can get by with a higher tolerance (and therefore a faster solve time within these chunks). By not updating the tolerances within <a href="../../api/kinetica/solving/#Kinetica.ODESimulationParams"><code>ODESimulationParams</code></a>, each simulation chunk starts at the default tolerances and only reduces them if necessary.</p></div></div><h2 id="implementation_low_rate"><a class="docs-heading-anchor" href="#implementation_low_rate">Removing Low-Rate Reactions</a><a id="implementation_low_rate-1"></a><a class="docs-heading-anchor-permalink" href="#implementation_low_rate" title="Permalink"></a></h2><p>When assembling a generated CRN into a system of ODEs to be integrated, some reactions can be purposefully left out if they have sufficiently low rates. This can be triggered with the <code>ODESimulationParams.low_k_cutoff</code> parameter by giving it a value other than <code>:none</code>. This calculates the maximum rate constant for every reaction, and reactions are then removed from the CRN if this maximum rate is below the cutoff. Setting the cutoff to <code>:auto</code> predicts a safe value, where maximum rates below this value will never change any species concentrations. This is checked by making sure that if a given reaction were to run at its maximum rate over the entire duration of the requested simulation (<code>ODESimulationParams.tspan[2]</code>, <span>$t_{\text{global}}$</span>) with maximum reactant concentrations set by <code>ODESimulationParams.low_k_maxconc</code> (<span>$c^2_{\text{max}}$</span>), any generated species concentration would still be less than the ODE solver&#39;s relative tolerance (<code>ODESimulationParams.reltol</code>):</p><p class="math-container">\[\text{remove reaction } i \text{ if } t_{\text{global}} \cdot c^2_{\text{max}}k_i^{\text{max}} &lt; reltol\]</p><p>Maximum rates of reaction are calculated by enumeration over all permutations of maximum and minimum values of the conditions being calculated against. This should account for the vast majority of cases as rates are usually highest at extrema of experimental conditions.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ase-calculator-builders/">« ASE Calculator Builders</a><a class="docs-footer-nextpage" href="../../api/kinetica/exploration/">Exploration »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.4 on <span class="colophon-date" title="Tuesday 27 May 2025 13:18">Tuesday 27 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
